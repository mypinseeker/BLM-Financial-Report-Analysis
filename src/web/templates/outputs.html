{% extends "base.html" %}
{% block title %}Analysis Outputs - BLM{% endblock %}

{% block extra_head %}
<style>
/* Highlight cards grid */
.highlight-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 16px;
    margin: 16px 0 32px;
}
.highlight-card {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 16px;
    border: 1px solid var(--border);
    transition: box-shadow .15s, transform .15s;
}
.highlight-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,.1);
    transform: translateY(-2px);
}
.highlight-card .card-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    word-break: break-all;
    margin-bottom: 8px;
}
.highlight-card .card-meta {
    font-size: 12px;
    color: var(--light-text);
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    margin-bottom: 8px;
}
.highlight-card .card-actions {
    margin-top: 8px;
    display: flex;
    gap: 12px;
}
/* Market accordion */
.market-accordion {
    margin-bottom: 16px;
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    background: var(--card-bg);
}
.market-accordion summary {
    padding: 14px 18px;
    font-weight: 600;
    font-size: 15px;
    color: var(--primary);
    cursor: pointer;
    background: #f8f8f8;
    list-style: none;
    display: flex;
    align-items: center;
    gap: 10px;
}
.market-accordion summary::-webkit-details-marker { display: none; }
.market-accordion summary::before {
    content: "\25B6";
    font-size: 11px;
    transition: transform .15s;
    color: var(--light-text);
}
.market-accordion[open] summary::before {
    transform: rotate(90deg);
}
.market-accordion summary .count {
    font-size: 12px;
    color: var(--light-text);
    background: #e8e8e8;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 400;
}
.market-accordion .accordion-body {
    padding: 12px 18px 18px;
}
.category-label {
    font-size: 13px;
    font-weight: 600;
    color: var(--primary-light);
    margin: 16px 0 6px;
    text-transform: uppercase;
    letter-spacing: .4px;
}
.category-label:first-child { margin-top: 0; }
/* Compact output table (no Market column inside accordion) */
.output-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--card-bg);
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--border);
    margin-bottom: 4px;
}
.output-table th {
    background: #f8f8f8;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: .4px;
    padding: 8px 12px;
    text-align: left;
    color: var(--light-text);
}
.output-table td {
    padding: 8px 12px;
    border-top: 1px solid #f0f0f0;
    font-size: 13px;
}
.output-table tr:hover td { background: #fafafa; }
/* Links */
.dl-link {
    color: var(--primary-light);
    font-weight: 600;
    text-decoration: none;
    font-size: 13px;
}
.dl-link:hover { text-decoration: underline; }
/* Summary metrics */
.output-summary {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    margin-bottom: 24px;
}
.output-summary .metric {
    min-width: 140px;
}
.empty-section {
    color: var(--light-text);
    font-size: 13px;
    padding: 12px 0;
    font-style: italic;
}
</style>
{% endblock %}

{# ============================================================ #}
{# Macros                                                        #}
{# ============================================================ #}

{# Type badge macro #}
{% macro type_badge(o) %}
    {% set ftype = o.file_type | default(o.output_type | default('')) %}
    <span class="badge {% if ftype == 'pptx' %}badge-primary{% elif ftype == 'pdf' %}badge-negative{% elif ftype == 'md' %}badge-positive{% elif ftype == 'html' %}badge-warning{% else %}badge-primary{% endif %}">
        {{ ftype | upper | default('FILE') }}
    </span>
{% endmacro %}

{# Render a compact output table (used inside each market accordion) #}
{% macro render_output_table(items) %}
<table class="output-table">
    <thead><tr>
        <th>File</th><th>Type</th><th>Operator</th><th>Created</th><th>Actions</th>
    </tr></thead>
    <tbody>
    {% for o in items %}
    <tr>
        <td>{{ o.file_name | default(o.storage_path | default('-')) }}</td>
        <td>{{ type_badge(o) }}</td>
        <td>{{ o.operator_id | default('-') }}</td>
        <td>{{ (o.created_at | default('-'))[:10] }}</td>
        <td>
            {% if o.id %}
                <a class="dl-link" href="/api/outputs/{{ o.id }}/download">Download</a>
                {% set fname = (o.file_name | default(o.storage_path | default(''))) | lower %}
                {% if fname.endswith('.json') %}
                    &nbsp;|&nbsp; <a class="dl-link" href="/report/{{ o.id }}" style="color:var(--positive);">View</a>
                {% endif %}
            {% else %}-{% endif %}
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>
{% endmacro %}

{# Categorize a list of outputs into 5 buckets, return namespace #}
{% macro _cat_test(o) %}
    {# Returns category string for an output â€” used in the for loop below #}
{% endmacro %}

{% block content %}
<h1 class="section-title">Analysis Outputs</h1>
<p class="meta" style="margin-bottom: 8px;">
    {{ outputs | length }} files across {{ sorted_markets | length }} markets
</p>

{% if outputs %}

<!-- Summary metrics -->
<div class="output-summary">
    <div class="metric">
        <div class="label">Total Files</div>
        <div class="value">{{ outputs | length }}</div>
    </div>
    <div class="metric">
        <div class="label">Markets</div>
        <div class="value">{{ sorted_markets | length }}</div>
    </div>
    <div class="metric">
        <div class="label">Latest</div>
        <div class="value">{{ (recent[0].created_at | default('-'))[:10] if recent else '-' }}</div>
    </div>
</div>

<!-- ============================================================ -->
<!-- Section 1: Latest Published (Highlight)                       -->
<!-- ============================================================ -->
{% if recent %}
<h2 class="section-title" style="font-size:18px; margin-top:16px;">Latest Published</h2>
<div class="highlight-grid">
{% for o in recent %}
    <div class="highlight-card">
        <div class="card-title">{{ o.file_name | default(o.storage_path | default('-')) }}</div>
        <div class="card-meta">
            {{ type_badge(o) }}
            <span>{{ market_names.get(o.market_id, o.market_id | default('-')) }}</span>
            {% if o.operator_id %}<span>{{ o.operator_id }}</span>{% endif %}
            <span>{{ (o.created_at | default('-'))[:10] }}</span>
        </div>
        <div class="card-actions">
            {% if o.id %}
                <a class="dl-link" href="/api/outputs/{{ o.id }}/download">Download</a>
                {% set fname = (o.file_name | default(o.storage_path | default(''))) | lower %}
                {% if fname.endswith('.json') %}
                    <a class="dl-link" href="/report/{{ o.id }}" style="color:var(--positive);">View Report</a>
                {% endif %}
            {% endif %}
        </div>
    </div>
{% endfor %}
</div>
{% endif %}

<!-- ============================================================ -->
<!-- Section 2: Reports by Market (Accordion Archive)              -->
<!-- ============================================================ -->
<h2 class="section-title" style="font-size:18px;">Reports by Market</h2>

{% for mid in sorted_markets %}
{% set market_items = by_market[mid] %}
<details class="market-accordion" id="market-{{ mid }}">
    <summary>
        {{ market_names.get(mid, mid | title) }}
        <span class="count">{{ market_items | length }} report{{ 's' if market_items | length != 1 else '' }}</span>
    </summary>
    <div class="accordion-body">
        {# Sub-categorize within this market #}
        {% set ns = namespace(five_looks=[], executive_summary=[], ppt=[], sending=[], other=[]) %}
        {% for o in market_items %}
            {% set cat = o.output_category | default('') | lower %}
            {% set fname = (o.file_name | default(o.storage_path | default(''))) | lower %}
            {% set ftype = (o.file_type | default(o.output_type | default(''))) | lower %}

            {% if cat == 'five_looks' or 'five_look' in fname or 'five-look' in fname
                  or 'look_at_' in fname or 'look-at-' in fname
                  or 'swot' in fname
                  or 'trend' in fname or 'market_customer' in fname
                  or 'competition' in fname or 'self_analysis' in fname
                  or 'opportunity' in fname %}
                {% set _ = ns.five_looks.append(o) %}
            {% elif cat == 'executive_summary' or 'executive' in fname or 'exec_summary' in fname
                    or 'summary' in fname or 'one_pager' in fname or 'one-pager' in fname
                    or 'overview' in fname %}
                {% set _ = ns.executive_summary.append(o) %}
            {% elif cat == 'ppt' or ftype == 'pptx' or '.pptx' in fname %}
                {% set _ = ns.ppt.append(o) %}
            {% elif cat == 'sending' or 'sending' in fname or 'delivery' in fname
                    or 'email' in fname or 'share' in fname or 'distribution' in fname %}
                {% set _ = ns.sending.append(o) %}
            {% else %}
                {% set _ = ns.other.append(o) %}
            {% endif %}
        {% endfor %}

        {% if ns.five_looks %}
        <div class="category-label">Five Looks Analysis ({{ ns.five_looks | length }})</div>
        {{ render_output_table(ns.five_looks) }}
        {% endif %}

        {% if ns.executive_summary %}
        <div class="category-label">Executive Summaries ({{ ns.executive_summary | length }})</div>
        {{ render_output_table(ns.executive_summary) }}
        {% endif %}

        {% if ns.ppt %}
        <div class="category-label">PowerPoint Presentations ({{ ns.ppt | length }})</div>
        {{ render_output_table(ns.ppt) }}
        {% endif %}

        {% if ns.sending %}
        <div class="category-label">Sending / Delivery ({{ ns.sending | length }})</div>
        {{ render_output_table(ns.sending) }}
        {% endif %}

        {% if ns.other %}
        <div class="category-label">Other ({{ ns.other | length }})</div>
        {{ render_output_table(ns.other) }}
        {% endif %}
    </div>
</details>
{% endfor %}

{% else %}
<div style="text-align: center; padding: 48px 0;">
    <p style="color: var(--light-text); font-size: 16px;">No output files found.</p>
    <p style="margin-top: 12px;">
        <a href="/analyze" style="color: var(--primary-light); font-weight: 600;">
            Start an analysis &rarr;
        </a>
    </p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Auto-open accordion if URL has #market-{id} hash
(function() {
    var hash = location.hash;
    if (hash && hash.startsWith('#market-')) {
        var el = document.querySelector(hash);
        if (el && el.tagName === 'DETAILS') el.open = true;
    }
})();
</script>
{% endblock %}
