{% extends "base.html" %}
{% block title %}BLM Dashboard{% endblock %}

{% block extra_head %}
<style>
/* KPI hero row */
.kpi-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 28px;
}
.kpi-card {
    background: var(--card-bg);
    border-radius: 10px;
    padding: 20px;
    border: 1px solid var(--border);
    text-align: center;
    transition: box-shadow .15s;
}
.kpi-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,.08); }
.kpi-label { font-size: 11px; color: var(--light-text); text-transform: uppercase; letter-spacing: .8px; font-weight: 600; }
.kpi-value { font-size: 32px; font-weight: 800; color: var(--primary); margin: 6px 0 2px; }
.kpi-sub { font-size: 12px; color: var(--light-text); }
/* Two-column layout */
.dash-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 24px;
}
@media (max-width: 900px) { .dash-grid { grid-template-columns: 1fr; } }
/* Market cards */
.market-card {
    background: var(--card-bg);
    border-radius: 10px;
    padding: 16px 20px;
    border: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: box-shadow .15s, transform .15s;
    text-decoration: none;
    color: inherit;
}
.market-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,.08);
    transform: translateY(-1px);
}
.market-name { font-weight: 700; font-size: 15px; color: var(--primary); }
.market-meta { font-size: 12px; color: var(--light-text); margin-top: 2px; }
.market-right { text-align: right; }
.market-rev { font-size: 18px; font-weight: 700; color: var(--text); }
.market-rev-label { font-size: 11px; color: var(--light-text); }
/* Sparkline canvas */
.sparkline { width: 80px; height: 28px; }
/* Job status */
.job-row {
    display: flex;
    gap: 8px;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
    font-size: 13px;
}
.job-row:last-child { border-bottom: none; }
.status-dot {
    width: 8px; height: 8px; border-radius: 50%; display: inline-block;
}
.status-completed { background: var(--positive); }
.status-pending { background: var(--warning); }
.status-failed { background: var(--negative); }
.status-running { background: #2196f3; }
/* Quick action btns */
.quick-actions {
    display: flex;
    gap: 10px;
    margin: 20px 0;
    flex-wrap: wrap;
}
.quick-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: opacity .15s;
}
.quick-btn:hover { opacity: .85; }
.quick-btn-primary { background: var(--primary); color: #fff; }
.quick-btn-outline { background: transparent; color: var(--primary); border: 2px solid var(--primary); }
/* Comparison table */
.cmp-table { font-size: 13px; }
.cmp-table th { font-size: 11px; padding: 8px 10px; white-space: nowrap; }
.cmp-table td { padding: 8px 10px; }
.cmp-table .num { text-align: right; font-variant-numeric: tabular-nums; }
.trend-up { color: var(--positive); }
.trend-down { color: var(--negative); }
.trend-flat { color: var(--light-text); }
</style>
{% endblock %}

{% block content %}
<h1 class="section-title" style="margin-top: 0;">Telecom Market Intelligence</h1>
<p style="color: var(--light-text); margin-bottom: 20px;">
    BLM Five Looks Strategic Analysis Platform &mdash; {{ markets | length }} markets
</p>

<!-- KPI Row -->
<div class="kpi-row" id="kpi-row">
    <div class="kpi-card">
        <div class="kpi-label">Markets</div>
        <div class="kpi-value">{{ markets | length }}</div>
        <div class="kpi-sub">Active</div>
    </div>
    <div class="kpi-card">
        <div class="kpi-label">Operators</div>
        <div class="kpi-value" id="kpi-operators">-</div>
        <div class="kpi-sub">Tracked</div>
    </div>
    <div class="kpi-card">
        <div class="kpi-label">Data Rows</div>
        <div class="kpi-value" id="kpi-rows">-</div>
        <div class="kpi-sub">In Supabase</div>
    </div>
    <div class="kpi-card">
        <div class="kpi-label">Analyses</div>
        <div class="kpi-value" id="kpi-analyses">-</div>
        <div class="kpi-sub" id="kpi-analyses-sub">Completed</div>
    </div>
</div>

<!-- Quick actions -->
<div class="quick-actions">
    <a href="/analyze" class="quick-btn quick-btn-primary">Run Analysis</a>
    <a href="/outputs" class="quick-btn quick-btn-outline">View Outputs</a>
    <a href="/audit" class="quick-btn quick-btn-outline">Market Audit</a>
    <a href="/review" class="quick-btn quick-btn-outline">Data Extraction</a>
</div>

<div class="dash-grid">
    <!-- Left: Revenue chart -->
    <div>
        <h2 class="section-title" style="font-size: 16px; margin-top: 8px;">Revenue by Market</h2>
        <div class="chart-container" style="height: 340px;">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>

    <!-- Right: Recent analysis jobs -->
    <div>
        <h2 class="section-title" style="font-size: 16px; margin-top: 8px;">Analysis Pipeline</h2>
        <div class="card" id="jobs-panel" style="min-height: 200px;">
            <p style="color: var(--light-text); font-size: 13px;">Loading...</p>
        </div>
    </div>
</div>

<!-- Market Comparison Table -->
<h2 class="section-title" style="font-size: 18px;">Cross-Market Comparison</h2>
<p style="color: var(--light-text); font-size: 13px; margin-bottom: 12px;">
    Latest available quarter &mdash; sorted by total revenue
</p>
<div style="overflow-x: auto;">
<table class="cmp-table" id="comparison-table">
    <thead><tr>
        <th>Market</th>
        <th>Operators</th>
        <th class="num">Revenue (M)</th>
        <th class="num">Subscribers (K)</th>
        <th>Trend</th>
        <th>Actions</th>
    </tr></thead>
    <tbody id="cmp-body">
        <tr><td colspan="6" style="color: var(--light-text); text-align: center; padding: 24px;">Loading comparison data...</td></tr>
    </tbody>
</table>
</div>

<!-- Market Cards Grid -->
<h2 class="section-title" style="font-size: 18px; margin-top: 32px;">Markets</h2>
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px; margin-top: 12px;">
{% for m in markets %}
    <a href="/market/{{ m.market_id }}" class="market-card">
        <div>
            <div class="market-name">{{ m.display_name | default(m.market_id | title) }}</div>
            <div class="market-meta">
                {% if m.country %}{{ m.country }}{% endif %}
                {% if m.currency %} &middot; {{ m.currency }}{% endif %}
                {% if m.operators_count %}
                 &middot; {{ m.operators_count }} operators
                {% endif %}
            </div>
        </div>
        <div class="market-right">
            <canvas class="sparkline" id="spark-{{ m.market_id }}"></canvas>
        </div>
    </a>
{% else %}
    <p style="color: var(--light-text);">No markets configured.</p>
{% endfor %}
</div>

{% if cloud_status %}
<details style="margin-top: 32px;">
    <summary style="cursor: pointer; font-weight: 600; color: var(--primary); font-size: 14px;">Cloud Data Status (Raw Table Counts)</summary>
    <table style="margin-top: 8px; font-size: 13px;">
        <thead><tr><th>Table</th><th>Rows</th></tr></thead>
        <tbody>
        {% for table, count in cloud_status.items() %}
            {% if table != 'total' %}
            <tr><td>{{ table }}</td><td>{{ count }}</td></tr>
            {% endif %}
        {% endfor %}
        <tr style="font-weight: bold;"><td>Total</td><td>{{ cloud_status.total | default(0) }}</td></tr>
        </tbody>
    </table>
</details>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// --- Fetch dashboard summary ---
fetch('/api/dashboard/summary')
    .then(r => r.json())
    .then(data => {
        document.getElementById('kpi-operators').textContent = data.total_operators || '-';
        document.getElementById('kpi-rows').textContent = formatNumber(data.total_data_rows || 0);
        const jobs = data.analysis_jobs || {};
        document.getElementById('kpi-analyses').textContent = jobs.completed || 0;
        document.getElementById('kpi-analyses-sub').textContent =
            (jobs.pending ? jobs.pending + ' pending' : '') +
            (jobs.failed ? (jobs.pending ? ', ' : '') + jobs.failed + ' failed' : '') ||
            'Completed';

        // Jobs panel
        renderJobs(data);
    })
    .catch(() => {
        document.getElementById('kpi-operators').textContent = '{{ markets | sum(attribute="operators_count") }}';
        document.getElementById('kpi-rows').textContent = '{{ cloud_status.total | default(0) }}';
        document.getElementById('kpi-analyses').textContent = '-';
    });

// --- Fetch comparison data ---
fetch('/api/dashboard/comparison')
    .then(r => r.json())
    .then(data => {
        renderComparison(data);
        renderRevenueChart(data);
        renderSparklines(data);
    })
    .catch(() => {
        document.getElementById('cmp-body').innerHTML =
            '<tr><td colspan="6" style="color:var(--negative);text-align:center;padding:16px;">Failed to load comparison data. Check Supabase connection.</td></tr>';
    });

function formatNumber(n) {
    if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
    if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
    return n.toString();
}

function formatRevenue(val, currency) {
    currency = currency || '';
    if (!val || val === 0) return '-';
    if (val >= 10000) return currency + (val / 1000).toFixed(1) + 'B';
    return currency + val.toFixed(0) + 'M';
}

function renderJobs(data) {
    const panel = document.getElementById('jobs-panel');
    const jobs = data.analysis_jobs || {};
    let html = '<div style="margin-bottom:12px;">';
    html += `<div class="job-row"><span class="status-dot status-completed"></span> <strong>${jobs.completed || 0}</strong> completed</div>`;
    if (jobs.pending) html += `<div class="job-row"><span class="status-dot status-pending"></span> <strong>${jobs.pending}</strong> pending</div>`;
    if (jobs.failed) html += `<div class="job-row"><span class="status-dot status-failed"></span> <strong>${jobs.failed}</strong> failed</div>`;
    html += '</div>';

    if (data.latest_job) {
        const j = data.latest_job;
        html += '<div style="font-size:12px;color:var(--light-text);border-top:1px solid var(--border);padding-top:10px;">';
        html += `Latest: Job #${j.id || '?'} &mdash; ${j.market || ''} / ${j.target_operator || j.group_id || ''}<br>`;
        html += `${j.created_at || ''}`;
        html += '</div>';
    }

    html += '<div style="margin-top:16px;">';
    html += '<a href="/analyze" class="quick-btn quick-btn-primary" style="font-size:13px;padding:8px 16px;">New Analysis</a>';
    html += '</div>';
    panel.innerHTML = html;
}

function renderComparison(data) {
    const tbody = document.getElementById('cmp-body');
    if (!data || !data.length) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--light-text);">No data</td></tr>';
        return;
    }
    let html = '';
    data.forEach(m => {
        const rev = m.total_revenue || 0;
        const subs = m.total_subs_k || 0;
        // Compute simple trend from top operator
        let trendIcon = '<span class="trend-flat">&mdash;</span>';
        if (m.operators && m.operators.length > 0) {
            const t = m.operators[0].revenue_trend || [];
            if (t.length >= 2) {
                const last = t[t.length - 1];
                const prev = t[t.length - 2];
                if (last > prev * 1.005) trendIcon = '<span class="trend-up">&#9650;</span>';
                else if (last < prev * 0.995) trendIcon = '<span class="trend-down">&#9660;</span>';
            }
        }
        html += `<tr>
            <td><a href="/market/${m.market_id}" style="color:var(--primary);font-weight:600;text-decoration:none;">${m.display_name}</a></td>
            <td>${m.operators_count}</td>
            <td class="num">${formatRevenue(rev, '')}</td>
            <td class="num">${formatNumber(subs)}</td>
            <td style="text-align:center;">${trendIcon}</td>
            <td>
                <a href="/market/${m.market_id}" style="font-size:12px;color:var(--primary-light);text-decoration:none;font-weight:600;">Details</a>
            </td>
        </tr>`;
    });
    tbody.innerHTML = html;
}

function renderRevenueChart(data) {
    const ctx = document.getElementById('revenueChart');
    if (!ctx || !data || !data.length) return;

    const labels = data.map(m => m.display_name || m.market_id);
    const values = data.map(m => m.total_revenue || 0);
    const colors = [
        '#1a237e', '#3949ab', '#5c6bc0', '#7986cb', '#9fa8da',
        '#c5cae9', '#ff6f00', '#ffa726', '#ffb74d', '#ffcc80',
        '#42a5f5', '#66bb6a'
    ];

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Total Revenue (M)',
                data: values,
                backgroundColor: colors.slice(0, values.length),
                borderRadius: 4,
                barThickness: 28,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => formatRevenue(ctx.parsed.y, '') + ' revenue'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { callback: v => formatRevenue(v, ''), font: { size: 11 } },
                    grid: { color: '#f0f0f0' }
                },
                x: {
                    ticks: { font: { size: 10 }, maxRotation: 45 },
                    grid: { display: false }
                }
            }
        }
    });
}

function renderSparklines(data) {
    if (!data) return;
    data.forEach(m => {
        const canvas = document.getElementById('spark-' + m.market_id);
        if (!canvas) return;
        // Aggregate revenue trend across operators
        const maxLen = Math.max(...(m.operators || []).map(o => (o.revenue_trend || []).length), 0);
        if (maxLen < 2) return;
        const agg = new Array(maxLen).fill(0);
        (m.operators || []).forEach(o => {
            (o.revenue_trend || []).forEach((v, i) => { agg[i] += v; });
        });
        new Chart(canvas, {
            type: 'line',
            data: {
                labels: agg.map((_, i) => i),
                datasets: [{
                    data: agg,
                    borderColor: '#3949ab',
                    borderWidth: 1.5,
                    pointRadius: 0,
                    fill: true,
                    backgroundColor: 'rgba(57,73,171,.08)',
                    tension: .3,
                }]
            },
            options: {
                responsive: false,
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                scales: {
                    x: { display: false },
                    y: { display: false }
                },
                animation: false,
            }
        });
    });
}
</script>
{% endblock %}
