{% extends "base.html" %}
{% block title %}Market Audit - BLM{% endblock %}

{% block extra_head %}
<style>
/* Audit selector */
.audit-form {
    background: var(--card-bg);
    border-radius: 10px;
    border: 1px solid var(--border);
    padding: 24px;
    margin-bottom: 24px;
}
.audit-form h2 { font-size: 16px; color: var(--primary); margin-bottom: 16px; }
.form-row {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    align-items: end;
}
.form-group {
    flex: 1;
    min-width: 180px;
}
.form-group label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--light-text);
    text-transform: uppercase;
    letter-spacing: .5px;
    margin-bottom: 4px;
}
.form-group select, .form-group input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 14px;
    background: #fff;
}
.run-btn {
    padding: 8px 24px;
    background: var(--primary);
    color: #fff;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity .15s;
    height: 38px;
}
.run-btn:hover { opacity: .85; }
.run-btn:disabled { opacity: .5; cursor: not-allowed; }
/* Score display */
.score-hero {
    display: flex;
    align-items: center;
    gap: 24px;
    padding: 24px;
    background: var(--card-bg);
    border-radius: 10px;
    border: 1px solid var(--border);
    margin-bottom: 20px;
}
.score-circle {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    flex-shrink: 0;
}
.grade-A { background: #e8f5e9; color: #2e7d32; border: 3px solid #4caf50; }
.grade-B { background: #e3f2fd; color: #1565c0; border: 3px solid #42a5f5; }
.grade-C { background: #fff3e0; color: #e65100; border: 3px solid #ff9800; }
.grade-D { background: #fff3e0; color: #bf360c; border: 3px solid #ff5722; }
.grade-F { background: #ffebee; color: #c62828; border: 3px solid #f44336; }
.score-number { font-size: 28px; }
.score-grade { font-size: 14px; }
.score-details h3 { font-size: 18px; margin-bottom: 8px; }
.score-details p { font-size: 13px; color: var(--light-text); line-height: 1.5; }
/* Layer breakdown */
.layer-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 24px;
}
@media (max-width: 768px) { .layer-grid { grid-template-columns: 1fr; } }
.layer-card {
    background: var(--card-bg);
    border-radius: 10px;
    border: 1px solid var(--border);
    padding: 20px;
    text-align: center;
}
.layer-card .layer-name { font-size: 12px; text-transform: uppercase; letter-spacing: .5px; color: var(--light-text); font-weight: 600; }
.layer-card .layer-score { font-size: 28px; font-weight: 800; color: var(--primary); margin: 6px 0; }
.layer-card .layer-weight { font-size: 11px; color: var(--light-text); }
/* Progress bar */
.progress-bar {
    height: 8px;
    background: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
    margin-top: 6px;
}
.progress-fill {
    height: 100%;
    border-radius: 4px;
    transition: width .3s;
}
.fill-high { background: var(--positive); }
.fill-medium { background: var(--warning); }
.fill-low { background: var(--negative); }
/* Table detail */
.detail-table { font-size: 13px; }
.detail-table th { font-size: 11px; }
.detail-table td { padding: 8px 10px; }
.detail-table .score-cell { font-weight: 700; font-variant-numeric: tabular-nums; }
/* Loading */
.audit-loading {
    text-align: center;
    padding: 40px;
    color: var(--light-text);
    display: none;
}
.audit-loading .spinner {
    display: inline-block;
    width: 28px; height: 28px;
    border: 3px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin .8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
{% endblock %}

{% block content %}
<h1 class="section-title" style="margin-top: 0;">Market Readiness Audit</h1>
<p style="color: var(--light-text); margin-bottom: 20px;">
    3-layer scoring: Data completeness (35%) + Analysis coverage (45%) + Provenance quality (20%)
</p>

<!-- Audit Form -->
<div class="audit-form">
    <h2>Select Audit Target</h2>
    <div class="form-row">
        <div class="form-group">
            <label>Target Market</label>
            <select id="market-select" onchange="updateOperators('target')">
                <option value="">-- Select Market --</option>
                {% for m in markets %}
                <option value="{{ m.market_id }}">{{ m.display_name | default(m.market_id | title) }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label>Target Operator</label>
            <select id="operator-select">
                <option value="">-- Select Operator --</option>
            </select>
        </div>
        <div class="form-group">
            <label>Reference Market (optional)</label>
            <select id="ref-market-select" onchange="updateOperators('ref')">
                <option value="">-- No Reference --</option>
                {% for m in markets %}
                <option value="{{ m.market_id }}">{{ m.display_name | default(m.market_id | title) }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label>Reference Operator</label>
            <select id="ref-operator-select">
                <option value="">-- Select --</option>
            </select>
        </div>
        <div class="form-group" style="flex: 0;">
            <label>&nbsp;</label>
            <button class="run-btn" id="run-btn" onclick="runAudit()">Run Audit</button>
        </div>
    </div>
</div>

<!-- Loading -->
<div class="audit-loading" id="audit-loading">
    <div class="spinner"></div>
    <p style="margin-top: 8px;">Running audit...</p>
</div>

<!-- Results (hidden until audit runs) -->
<div id="audit-results" style="display: none;">

    <!-- Score hero -->
    <div class="score-hero" id="score-hero">
        <div class="score-circle" id="score-circle">
            <div class="score-number" id="score-number">-</div>
            <div class="score-grade" id="score-letter">-</div>
        </div>
        <div class="score-details">
            <h3 id="audit-title">Audit Result</h3>
            <p id="audit-summary">-</p>
        </div>
    </div>

    <!-- Layer breakdown -->
    <h2 class="section-title" style="font-size: 16px;">Score Breakdown</h2>
    <div class="layer-grid" id="layer-grid"></div>

    <!-- Per-table detail -->
    <h2 class="section-title" style="font-size: 16px;">Data Layer Detail</h2>
    <div style="overflow-x: auto;">
        <table class="detail-table" id="detail-table">
            <thead><tr><th>Table</th><th class="num">Score</th><th>Completeness</th><th>Details</th></tr></thead>
            <tbody id="detail-body"></tbody>
        </table>
    </div>

    <!-- Export -->
    <div style="margin-top: 20px;">
        <button class="run-btn" onclick="exportAudit()" style="background: var(--primary-light);">Export JSON</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const MARKET_OPS = {{ market_operators_json | safe }};
let lastAuditData = null;

function updateOperators(target) {
    const selectId = target === 'ref' ? 'ref-market-select' : 'market-select';
    const opSelectId = target === 'ref' ? 'ref-operator-select' : 'operator-select';
    const market = document.getElementById(selectId).value;
    const opSelect = document.getElementById(opSelectId);
    opSelect.innerHTML = '<option value="">-- Select Operator --</option>';
    if (market && MARKET_OPS[market]) {
        MARKET_OPS[market].forEach(op => {
            const opt = document.createElement('option');
            opt.value = op.operator_id;
            opt.textContent = op.display_name || op.operator_id;
            opSelect.appendChild(opt);
        });
        // Auto-select first
        if (MARKET_OPS[market].length === 1) {
            opSelect.value = MARKET_OPS[market][0].operator_id;
        }
    }
}

function runAudit() {
    const market = document.getElementById('market-select').value;
    const operator = document.getElementById('operator-select').value;
    const refMarket = document.getElementById('ref-market-select').value;
    const refOp = document.getElementById('ref-operator-select').value;

    if (!market || !operator) {
        alert('Please select a target market and operator.');
        return;
    }

    let url = `/api/audit/${market}?operator=${operator}`;
    if (refMarket && refOp) {
        url += `&reference=${refMarket}&ref_operator=${refOp}`;
    }

    document.getElementById('audit-loading').style.display = 'block';
    document.getElementById('audit-results').style.display = 'none';
    document.getElementById('run-btn').disabled = true;

    fetch(url)
        .then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.json();
        })
        .then(data => {
            lastAuditData = data;
            renderAuditResults(data);
            document.getElementById('audit-loading').style.display = 'none';
            document.getElementById('audit-results').style.display = 'block';
            document.getElementById('run-btn').disabled = false;
        })
        .catch(err => {
            document.getElementById('audit-loading').innerHTML =
                `<p style="color:var(--negative);">Audit failed: ${err.message}</p>`;
            document.getElementById('run-btn').disabled = false;
        });
}

function renderAuditResults(data) {
    // Overall score
    const score = Math.round(data.overall_score || 0);
    const grade = data.grade || 'F';
    document.getElementById('score-number').textContent = score;
    document.getElementById('score-letter').textContent = grade;

    const circle = document.getElementById('score-circle');
    circle.className = `score-circle grade-${grade}`;

    const marketName = (document.getElementById('market-select').value || '').replace(/_/g, ' ');
    const opName = document.getElementById('operator-select').selectedOptions[0]?.textContent || '';
    document.getElementById('audit-title').textContent = `${opName} - ${marketName}`;
    document.getElementById('audit-summary').textContent =
        `Overall score: ${score}/100 (Grade ${grade}). ` +
        `Data: ${Math.round(data.data_score || 0)}/100, ` +
        `Analysis: ${Math.round(data.analysis_score || 0)}/100, ` +
        `Provenance: ${Math.round(data.provenance_score || 0)}/100`;

    // Layer breakdown
    const layers = [
        { name: 'Data Completeness', score: data.data_score || 0, weight: '35%' },
        { name: 'Analysis Coverage', score: data.analysis_score || 0, weight: '45%' },
        { name: 'Provenance Quality', score: data.provenance_score || 0, weight: '20%' },
    ];
    document.getElementById('layer-grid').innerHTML = layers.map(l => {
        const s = Math.round(l.score);
        const fillClass = s >= 80 ? 'fill-high' : s >= 60 ? 'fill-medium' : 'fill-low';
        return `<div class="layer-card">
            <div class="layer-name">${l.name}</div>
            <div class="layer-score">${s}</div>
            <div class="layer-weight">Weight: ${l.weight}</div>
            <div class="progress-bar"><div class="progress-fill ${fillClass}" style="width:${s}%;"></div></div>
        </div>`;
    }).join('');

    // Per-table detail
    const tables = data.data_detail || data.table_scores || {};
    const tbody = document.getElementById('detail-body');
    const tableEntries = typeof tables === 'object' && !Array.isArray(tables)
        ? Object.entries(tables)
        : (Array.isArray(tables) ? tables.map(t => [t.table_name || t.name, t]) : []);

    if (tableEntries.length) {
        tbody.innerHTML = tableEntries.map(([name, detail]) => {
            const s = typeof detail === 'number' ? detail : (detail.score || detail.completeness || 0);
            const pct = Math.round(s);
            const fillClass = pct >= 80 ? 'fill-high' : pct >= 60 ? 'fill-medium' : 'fill-low';
            const detailText = typeof detail === 'object'
                ? (detail.missing_fields || []).join(', ') || (detail.note || '-')
                : '-';
            return `<tr>
                <td>${name.replace(/_/g, ' ')}</td>
                <td class="num score-cell">${pct}</td>
                <td style="min-width:120px;">
                    <div class="progress-bar"><div class="progress-fill ${fillClass}" style="width:${pct}%;"></div></div>
                </td>
                <td style="font-size:12px;color:var(--light-text);">${detailText}</td>
            </tr>`;
        }).join('');
    } else {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--light-text);">No table detail available</td></tr>';
    }
}

function exportAudit() {
    if (!lastAuditData) return;
    const blob = new Blob([JSON.stringify(lastAuditData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'audit_report.json';
    a.click();
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}
